{"version":3,"file":"prepare.js","names":["fs","require","Module","finalize","getMainPath","generateDict","options","resolvePath","mainPath","mapFile","existsSync","Error","JSON","parse","readFileSync","e","console","error","module","exports","buildLinking","moduleLoader","_load","transpiled","entryFile","deps"],"sources":["../../src/prepare.js"],"sourcesContent":["/*\n * Hardwired Copyright (c) 2023 JÄ™drzej Majko (jdrzjm@gmail.com)\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\nconst fs = require('fs');\nconst Module = require('module');\nconst finalize = require('./utils/finalize.js');\nconst getMainPath = require('./utils/mainPath.js');\n\n/**\n * Generate readable map from map file (it's an array ;))\n * @param options\n * @returns {{}|any}\n */\nconst generateDict = (options) => {\n  const resolvePath = options.mainPath + options.mapFile;\n  if (fs.existsSync(resolvePath) === false) {\n    throw new Error('Hardwired: Map file not found in ', resolvePath);\n  }\n  try {\n    return JSON.parse(fs.readFileSync(resolvePath, 'utf8'));\n  } catch (e) {\n    console.error('Hardwired: Cannot read JSON map file', resolvePath, e);\n    return {};\n  }\n};\n\n/**\n * Hardwire your code, returns a stringified, hardwired json\n * @param options\n * @returns {Promise<string|void|null>}\n */\nmodule.exports = async (options) => {\n  if (typeof options.mainPath === 'undefined') {\n    options.mainPath = getMainPath();\n  }\n\n  const buildLinking = generateDict(options);\n\n  const { moduleLoader } = require('./utils/moduleLoader.js');\n  Module._load = moduleLoader(buildLinking, options);\n\n  try {\n    const { transpiled, entryFile, deps } = await require('./transpile.js')(\n      options\n    );\n    return await finalize(transpiled, options, entryFile, deps);\n  } catch (e) {\n    console.error('Hardwired', e);\n    return null;\n  }\n};\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,MAAMA,EAAE,GAAGC,OAAO,CAAC,IAAI,CAAC;AACxB,MAAMC,MAAM,GAAGD,OAAO,CAAC,QAAQ,CAAC;AAChC,MAAME,QAAQ,GAAGF,OAAO,CAAC,qBAAqB,CAAC;AAC/C,MAAMG,WAAW,GAAGH,OAAO,CAAC,qBAAqB,CAAC;;AAElD;AACA;AACA;AACA;AACA;AACA,MAAMI,YAAY,GAAIC,OAAO,IAAK;EAChC,MAAMC,WAAW,GAAGD,OAAO,CAACE,QAAQ,GAAGF,OAAO,CAACG,OAAO;EACtD,IAAIT,EAAE,CAACU,UAAU,CAACH,WAAW,CAAC,KAAK,KAAK,EAAE;IACxC,MAAM,IAAII,KAAK,CAAC,mCAAmC,EAAEJ,WAAW,CAAC;EACnE;EACA,IAAI;IACF,OAAOK,IAAI,CAACC,KAAK,CAACb,EAAE,CAACc,YAAY,CAACP,WAAW,EAAE,MAAM,CAAC,CAAC;EACzD,CAAC,CAAC,OAAOQ,CAAC,EAAE;IACVC,OAAO,CAACC,KAAK,CAAC,sCAAsC,EAAEV,WAAW,EAAEQ,CAAC,CAAC;IACrE,OAAO,CAAC,CAAC;EACX;AACF,CAAC;;AAED;AACA;AACA;AACA;AACA;AACAG,MAAM,CAACC,OAAO,GAAG,MAAOb,OAAO,IAAK;EAClC,IAAI,OAAOA,OAAO,CAACE,QAAQ,KAAK,WAAW,EAAE;IAC3CF,OAAO,CAACE,QAAQ,GAAGJ,WAAW,CAAC,CAAC;EAClC;EAEA,MAAMgB,YAAY,GAAGf,YAAY,CAACC,OAAO,CAAC;EAE1C,MAAM;IAAEe;EAAa,CAAC,GAAGpB,OAAO,CAAC,yBAAyB,CAAC;EAC3DC,MAAM,CAACoB,KAAK,GAAGD,YAAY,CAACD,YAAY,EAAEd,OAAO,CAAC;EAElD,IAAI;IACF,MAAM;MAAEiB,UAAU;MAAEC,SAAS;MAAEC;IAAK,CAAC,GAAG,MAAMxB,OAAO,CAAC,gBAAgB,CAAC,CACrEK,OACF,CAAC;IACD,OAAO,MAAMH,QAAQ,CAACoB,UAAU,EAAEjB,OAAO,EAAEkB,SAAS,EAAEC,IAAI,CAAC;EAC7D,CAAC,CAAC,OAAOV,CAAC,EAAE;IACVC,OAAO,CAACC,KAAK,CAAC,WAAW,EAAEF,CAAC,CAAC;IAC7B,OAAO,IAAI;EACb;AACF,CAAC"}