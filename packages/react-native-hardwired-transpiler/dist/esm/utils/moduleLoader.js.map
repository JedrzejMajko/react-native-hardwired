{"version":3,"file":"moduleLoader.js","names":["path","require","Module","originalLoader","_load","extendedGetResolveDependencyFn","getResolveDependencyFn","options","map","mainPath","bundler","platform","resolverOptions","resolveFn","from","to","console","log","xpathTo","relative","length","error","moduleLoader","request","parent","original","match","id","result","i","module","exports"],"sources":["../../../src/utils/moduleLoader.js"],"sourcesContent":["/*\n * Copyright (c) 2023 JÄ™drzej Majko (jdrzjm@gmail.com)\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\nconst path = require('path');\nconst Module = require('module');\n\nconst originalLoader = Module._load;\n\n/**\n * Extends metro's getResolveDependencyFn to add a custom resolver.\n * @param getResolveDependencyFn\n * @param options\n * @param map\n * @returns {function(*, *, *): Promise<function(*, *): (number | string | ((value: any, helpers: Joi.CustomHelpers) => any))>}\n */\nconst extendedGetResolveDependencyFn = function (\n  getResolveDependencyFn,\n  options,\n  map\n) {\n  const mainPath = options.mainPath;\n\n  return async function (bundler, platform, resolverOptions) {\n    const resolveFn = await getResolveDependencyFn(\n      bundler,\n      platform,\n      resolverOptions\n    );\n\n    return (from, to) => {\n      console.log('CALL');\n      const xpathTo = path.relative(mainPath, to);\n\n      if (\n        typeof map[xpathTo] === 'object' &&\n        map[xpathTo] !== null &&\n        map[xpathTo].length > 0\n      ) {\n        return map[xpathTo][0];\n      } else {\n        console.error(\n          'Hardwired: Cannot find path to module in map (',\n          xpathTo,\n          ').'\n        );\n      }\n\n      return resolveFn(from, to);\n    };\n  };\n};\n\n/**\n * Intercept metro's transformHelpers module and extends it with our custom resolver.\n * @param map\n * @param options\n * @returns {(function(*, *): ({}))|*}\n */\nconst moduleLoader = function (map, options) {\n  return function (request, parent) {\n    const original = originalLoader(request, parent);\n\n    if (\n      typeof request === 'string' &&\n      request.match('lib/transformHelpers') &&\n      parent &&\n      parent.id.match(/\\/transpile\\.js$/)\n    ) {\n      const getResolveDependencyFn = original.getResolveDependencyFn;\n      const result = {};\n      /**\n       * Implicitly extend the original getResolveDependencyFn with our custom resolver.\n       * Use shallow copy to avoid modifying the original object.\n       */\n      for (let i in original) {\n        if (i === 'getResolveDependencyFn') {\n          result[i] = extendedGetResolveDependencyFn(\n            getResolveDependencyFn,\n            options,\n            map\n          );\n          continue;\n        }\n        result[i] = original[i];\n      }\n      return result;\n    }\n    return original;\n  };\n};\n\nmodule.exports = {\n  extendedGetResolveDependencyFn,\n  moduleLoader,\n};\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAM,CAAC;AAC5B,MAAMC,MAAM,GAAGD,OAAO,CAAC,QAAQ,CAAC;AAEhC,MAAME,cAAc,GAAGD,MAAM,CAACE,KAAK;;AAEnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMC,8BAA8B,GAAG,SAAAA,CACrCC,sBAAsB,EACtBC,OAAO,EACPC,GAAG,EACH;EACA,MAAMC,QAAQ,GAAGF,OAAO,CAACE,QAAQ;EAEjC,OAAO,gBAAgBC,OAAO,EAAEC,QAAQ,EAAEC,eAAe,EAAE;IACzD,MAAMC,SAAS,GAAG,MAAMP,sBAAsB,CAC5CI,OAAO,EACPC,QAAQ,EACRC,eACF,CAAC;IAED,OAAO,CAACE,IAAI,EAAEC,EAAE,KAAK;MACnBC,OAAO,CAACC,GAAG,CAAC,MAAM,CAAC;MACnB,MAAMC,OAAO,GAAGlB,IAAI,CAACmB,QAAQ,CAACV,QAAQ,EAAEM,EAAE,CAAC;MAE3C,IACE,OAAOP,GAAG,CAACU,OAAO,CAAC,KAAK,QAAQ,IAChCV,GAAG,CAACU,OAAO,CAAC,KAAK,IAAI,IACrBV,GAAG,CAACU,OAAO,CAAC,CAACE,MAAM,GAAG,CAAC,EACvB;QACA,OAAOZ,GAAG,CAACU,OAAO,CAAC,CAAC,CAAC,CAAC;MACxB,CAAC,MAAM;QACLF,OAAO,CAACK,KAAK,CACX,gDAAgD,EAChDH,OAAO,EACP,IACF,CAAC;MACH;MAEA,OAAOL,SAAS,CAACC,IAAI,EAAEC,EAAE,CAAC;IAC5B,CAAC;EACH,CAAC;AACH,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA,MAAMO,YAAY,GAAG,SAAAA,CAAUd,GAAG,EAAED,OAAO,EAAE;EAC3C,OAAO,UAAUgB,OAAO,EAAEC,MAAM,EAAE;IAChC,MAAMC,QAAQ,GAAGtB,cAAc,CAACoB,OAAO,EAAEC,MAAM,CAAC;IAEhD,IACE,OAAOD,OAAO,KAAK,QAAQ,IAC3BA,OAAO,CAACG,KAAK,CAAC,sBAAsB,CAAC,IACrCF,MAAM,IACNA,MAAM,CAACG,EAAE,CAACD,KAAK,CAAC,kBAAkB,CAAC,EACnC;MACA,MAAMpB,sBAAsB,GAAGmB,QAAQ,CAACnB,sBAAsB;MAC9D,MAAMsB,MAAM,GAAG,CAAC,CAAC;MACjB;AACN;AACA;AACA;MACM,KAAK,IAAIC,CAAC,IAAIJ,QAAQ,EAAE;QACtB,IAAII,CAAC,KAAK,wBAAwB,EAAE;UAClCD,MAAM,CAACC,CAAC,CAAC,GAAGxB,8BAA8B,CACxCC,sBAAsB,EACtBC,OAAO,EACPC,GACF,CAAC;UACD;QACF;QACAoB,MAAM,CAACC,CAAC,CAAC,GAAGJ,QAAQ,CAACI,CAAC,CAAC;MACzB;MACA,OAAOD,MAAM;IACf;IACA,OAAOH,QAAQ;EACjB,CAAC;AACH,CAAC;AAEDK,MAAM,CAACC,OAAO,GAAG;EACf1B,8BAA8B;EAC9BiB;AACF,CAAC"}